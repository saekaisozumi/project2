<input type="text" name="search" placeholder="search a cafe">
{{!-- <input type="submit" value="submit"> --}}
<button>Submit</button>
{{!-- </form> --}}
<a href="/logout">Log out</a>

<h1>hello</h1>


<div id='map' style='width: 800px; height: 500px;'></div>

<script>
  mapboxgl.accessToken =
    "pk.eyJ1Ijoic2Fla2ExMTExIiwiYSI6ImNrNmhxcXZzeTB6MHUzbm1sZGg4dmd4NTcifQ.n75w0QK5TPx_Qrdq3zeyQA";
  var map = new mapboxgl.Map({
    container: "map",
    style: "mapbox://styles/saeka1111/ck6i1o1ma00zl1ipfgj2vyew4",
    center: [13.404019, 52.519083],
    zoom: 11.15
  });

  const nav = new mapboxgl.NavigationControl();
  map.addControl(nav, "top-right"); // where map refers to the name of our instance of Map

  const geolocate = new mapboxgl.GeolocateControl({
    showUserLocation: false, // default is true, defines whether a dot should be shown where user is located
    trackUserLocation: true // default is false, allows to update user location on the map if the user's location changes
  });
  map.addControl(geolocate, "top-right");

  //const cafeId = location.pathname.split('/')[1] // /main  NEED TO BE AN ACTUAL ID
  axios.get(`http://localhost:3000/caffees`).then(response => {
    console.log("RESPONSE ID", response.data)
    response.data.forEach(elem => {
      console.log(elem.coordinates)
      let coordinates = elem.coordinates;
      if (!coordinates.longitude && !coordinates.latitude) coordinates = map.getCenter();
      const marker = new mapboxgl.Marker(
        { draggable: false }
      )


      marker.setLngLat({ lng: coordinates.longitude, lat: coordinates.latitude });
      marker.addTo(map);

      const popup = new mapboxgl.Popup();
      popup.setLngLat({ lng: coordinates.longitude, lat: coordinates.latitude }); // in order to have longitude before latitude the data is reversed because it appears as latitude before longitude but if it is reversed here it will be reversed a second time negating the effect thus for the second time it is left as is
      popup.setHTML(`<div><img src="${elem.image_url}" alt="" style="width:130px;height:130px;"> <a href="/details.hbs"><h3 >${elem.name}</h3></a><p> Address: ${elem.location.address1},${elem.location.zip_code},${elem.location.city} </p>
      <p>Telephone:${elem.display_phone} </p><p> Rating: ${elem.rating}<p></div>`);
      marker.setPopup(popup);

    })
    return
    /*marker.on('dragend', (data) => {
      const coord = data.target.getLngLat().toArray();*/
    marker.on("dragend", data => {
      const coord = data.target.coordinates;             //getLngLat().toArray();
      axios
        .patch(`http://localhost:3000/main`, { coordinates: coord })
        .then(() => {
          console.log("communities shown!");
        })
        .catch(err => {
          console.log(err);
        });

    })


  })

</script>